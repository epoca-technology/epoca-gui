<!-- Secondary Header -->
<mat-toolbar class="secondary-header">
    <div fxLayout="row" fxLayoutAlign="center center">
        <button mat-icon-button 
                *ngIf="epoch"
                [disabled]="submitting"
                (click)="initializeEpochData()"><mat-icon>arrow_back</mat-icon></button>
        <span *ngIf="!epoch" class="truncate">Predictions</span>
        <span *ngIf="epoch" class="truncate">{{initialized ? epoch.record.id: 'Predictions'}}</span>
        <span fxFlex></span>
        
        <!-- Chart View -->
        <button mat-icon-button 
                *ngIf="initialized && epoch && loaded" 
                [disabled]="view == 'line' || submitting"
                matTooltip="Enable Line View"
                (click)="activateView('line')"><mat-icon>insights</mat-icon></button>
        
        <!-- Candlesticks View -->
        <button mat-icon-button 
                *ngIf="initialized && epoch && loaded" 
                [disabled]="view == 'candlesticks' || submitting"
                matTooltip="Enable Candlesticks View"
                (click)="activateView('candlesticks')"><mat-icon>waterfall_chart</mat-icon></button>

        <!-- Grid View -->
        <button mat-icon-button 
                *ngIf="initialized && epoch && loaded" 
                [disabled]="view == 'grid' || submitting"
                matTooltip="Enable Grid View"
                (click)="activateView('grid')"><mat-icon>grid_view</mat-icon></button>
    </div>
</mat-toolbar>

<!-- Content -->
<div [ngClass]="{'section-content': layout == 'mobile'}" class="padding">
    <div>
        <!-- Initialization Loader -->
        <div *ngIf="!initialized && initializing" class="section-loader">
            <div fxLayout="row" fxLayoutAlign="center center"><mat-spinner diameter="50"></mat-spinner></div>
        </div>

        <!-- Epoch Menu -->
        <div *ngIf="initialized && !epoch" fxLayout="row" fxLayoutAlign="center center">
            <div fxFlex="30" fxFlex.xs="100" fxFlex.sm="100">
                <app-epochs-menu (epochID)="initializeEpochData($event)"></app-epochs-menu>
            </div>
        </div>

        <!-- Prediction Container -->
        <div *ngIf="initialized && epoch">
            <!-- Loader -->
            <div *ngIf="!loaded" class="section-loader">
                <div fxLayout="row" fxLayoutAlign="center center"><mat-spinner diameter="50"></mat-spinner></div>
            </div>

            <!-- Prediction Content -->
            <div *ngIf="loaded">
                <!-- Starred Predictions -->
                <div *ngIf="starredList.length" class="fadeIn">
                    <mat-grid-list [cols]="gridCols" rowHeight="60" gutterSize="15">
                        <mat-grid-tile 
                            *ngFor="let pred of starredList"
                            class="prediction-tile mat-elevation-z2 fake-button">
                            <div class="full-width prediction-tile-inner">
                                <div fxLayout="row" fxLayoutAlign="start center">
                                    <div class="clickable" (click)="_nav.displayPredictionDialog(epoch.record.model, pred, undefined, undefined, epoch.record)">
                                        <div fxLayout="row" fxLayoutAlign="start center">
                                            <img src="{{_prediction.resultImagePaths[pred.r]}}" alt="Model Type" class="model-logo-xs">
                                            <h5>{{_prediction.resultNames[pred.r]}}</h5>
                                        </div>
                                        <p class="light-text ts-xs truncate">{{pred.t | date: 'medium'}}</p>
                                    </div>
                                    <span fxFlex></span>
                                    <div class="clickable" 
                                        [ngClass]="{
                                            'square-badge-success': pred.r == 1,
                                            'square-badge-error': pred.r == -1,
                                            'square-badge-neutral': pred.r == 0
                                        }" matTooltip="{{pred.s}}" 
                                        (click)="starAction(pred)">
                                        {{pred.s | number: '1.0-2'}}
                                    </div>
                                </div>
                            </div>
                        </mat-grid-tile>
                    </mat-grid-list>
                </div>

                <!-- Prediction Hist -->
                <div *ngIf="view == 'line' && predictionsHist" style="overflow: hidden;" class="fadeIn">
                    <apx-chart
                        [series]="predictionsHist.series"
                        [chart]="predictionsHist.chart"
                        [dataLabels]="predictionsHist.dataLabels"
                        [xaxis]="predictionsHist.xaxis"
                        [yaxis]="predictionsHist.yaxis"
                        [stroke]="predictionsHist.stroke"
                        [annotations]="predictionsHist.annotations"
                    ></apx-chart>
                </div>

                <!-- Prediction Candlesticks -->
                <div *ngIf="view == 'candlesticks'" class="fadeIn" [ngClass]="{'margin-top': starredList.length}">
                    <div *ngIf="candlesticksChart" style="overflow: hidden;">
                        <apx-chart
                            [series]="candlesticksChart.series!"
                            [chart]="candlesticksChart.chart!"
                            [plotOptions]="candlesticksChart.plotOptions!"
                            [xaxis]="candlesticksChart.xaxis!"
                            [yaxis]="candlesticksChart.yaxis!"
                            [annotations]="candlesticksChart!.annotations!"
                            [title]="candlesticksChart.title!"
                        ></apx-chart>
                    </div>
                </div>

                <!-- Prediction Grid -->
                <div *ngIf="view == 'grid'" class="fadeIn">
                    <div *ngIf="starredList.length" class="divider"></div>
                    <mat-grid-list [cols]="gridCols" rowHeight="60" gutterSize="15">
                        <div *ngFor="let pred of predictions; index as predIndex">
                            <mat-grid-tile 
                                *ngIf="predIndex < visibleTiles"
                                class="prediction-tile mat-elevation-z2 fake-button">
                                <div class="full-width prediction-tile-inner">
                                    <div fxLayout="row" fxLayoutAlign="start center">
                                        <div class="clickable" (click)="_nav.displayPredictionDialog(epoch.record.model, pred, undefined, undefined, epoch.record)">
                                            <div fxLayout="row" fxLayoutAlign="start center">
                                                <img src="{{_prediction.resultImagePaths[pred.r]}}" alt="Model Type" class="model-logo-xs">
                                                <h5>{{_prediction.resultNames[pred.r]}}</h5>
                                            </div>
                                            <p class="light-text ts-xs truncate">{{pred.t | date: 'medium'}}</p>
                                        </div>
                                        <span fxFlex></span>
                                        <div class="clickable" 
                                            [ngClass]="{
                                                'square-badge-success': pred.r == 1,
                                                'square-badge-error': pred.r == -1,
                                                'square-badge-neutral': pred.r == 0,
                                                'unstarred-prediction': !starred[pred.t]
                                            }" matTooltip="{{pred.s}}" 
                                            (click)="starAction(pred)">
                                            {{pred.s | number: '1.0-2'}}
                                        </div>
                                    </div>
                                </div>
                            </mat-grid-tile>
                        </div>

                        <mat-grid-tile *ngIf="hasMore || visibleTiles < predictions.length" 
                                    class="clickable fake-button" role="button" 
                                    (click)="viewMore()">
                            {{submitting ? 'Loading...': 'View More'}}
                        </mat-grid-tile>
                    </mat-grid-list>
                </div>
            </div>



            <!-- Candlesticks Settings Fab -->
            <div *ngIf="hasMore && view == 'candlesticks'" class="prediction-loader-fab">
                <button mat-fab color="primary" class="show-on-desktop"
                    [disabled]="submitting || !loaded"
                    (click)="activateCandlesticks()">
                    <mat-icon>settings</mat-icon>
                </button>
                <button mat-mini-fab color="primary" class="show-on-mobile"
                    [disabled]="submitting || !loaded"
                    (click)="activateCandlesticks()">
                    <mat-icon>settings</mat-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Tabs -->
    <app-mobile-tabs *ngIf="layout == 'mobile'"></app-mobile-tabs>
</div>
